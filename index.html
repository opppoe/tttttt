<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>YouTube Search Player (YTM bar)</title>
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <style>
    :root{
      --bg:#000;
      --card:#1c1c1e;
      --elev:#2c2c2e;
      --text:#fff;
      --sub:rgba(255,255,255,.65);
      --accent:#007aff;
      --border:rgba(255,255,255,.12);
      --radius:14px;
      --gap:16px;
      --minCard:300px;
      --yt-red:#ff0000;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:16px;
      font-family:"SF Pro Display","Helvetica Neue",Arial,sans-serif;
      background:var(--bg);color:var(--text);
      padding-bottom:calc(16px + 74px);
      -webkit-font-smoothing:antialiased;
    }
    .container{width:100%;padding:0 8px}
    header{
      background:rgba(28,28,30,.86);backdrop-filter:blur(12px);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px 14px;
      display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
      margin-bottom:12px;
      box-shadow:0 14px 34px rgba(0,0,0,.55);
    }
    h1{margin:0;font-size:18px;font-weight:900;letter-spacing:.2px}
    .muted{color:var(--sub);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;width:100%}
    input,select{
      background:var(--elev);border:1px solid var(--border);color:var(--text);
      padding:10px 12px;border-radius:12px;outline:none;font-size:14px;
    }
    input:focus,select:focus{border-color:rgba(0,122,255,.75);box-shadow:0 0 0 3px rgba(0,122,255,.22)}
    input::placeholder{color:rgba(255,255,255,.45)}
    button{
      background:var(--accent);color:#fff;border:0;
      padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer;
    }
    button.secondary{
      background:rgba(255,255,255,.08);border:1px solid var(--border);
    }
    button.secondary:hover{background:rgba(255,255,255,.12)}
    label.chk{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      padding:9px 12px;border-radius:12px;font-size:13px;color:var(--sub);
      user-select:none;
    }
    label.chk input{width:16px;height:16px;accent-color:var(--accent)}
    #apiKey{width:210px}
    #keyword{flex:1;min-width:220px}

    /* Results */
    #status{margin:0 0 10px}
    #results.grid{
      display:grid;gap:var(--gap);
      grid-template-columns:repeat(auto-fill, minmax(var(--minCard), 1fr));
      align-items:stretch;
    }
    #results.list{
      display:block;
      border-radius:var(--radius);
      overflow:hidden;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
    }
    .center{padding:56px 10px;text-align:center;color:rgba(255,255,255,.55);font-size:15px}

    /* Card */
    .card{
      background:rgba(28,28,30,.92);
      border-radius:var(--radius);
      overflow:hidden;
      cursor:pointer;
      outline:1px solid rgba(255,255,255,.09);
      outline-offset:-1px;
      transition:.14s ease;
      position:relative;
      display:flex;flex-direction:column;
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.35);background:rgba(44,44,46,.92)}
    .card.active{outline:2px solid rgba(0,122,255,.85);outline-offset:-2px}
    .thumb{position:relative}
    .thumb img{width:100%;aspect-ratio:16/9;object-fit:cover;display:block}
    .dur{
      position:absolute;right:10px;bottom:10px;
      background:rgba(0,0,0,.7);
      padding:4px 8px;border-radius:10px;
      font-size:12px;font-weight:900;
    }
    .body{padding:14px;display:grid;gap:8px}
    .title{
      font-weight:900;font-size:15px;line-height:1.35;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:var(--sub);font-size:12px}
    .chip{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.10);padding:4px 10px;border-radius:999px;color:#fff;font-weight:900;font-size:11px}
    .ch-row{display:flex;align-items:center;gap:8px;min-width:0}
    .ch-row span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
    .ch-fav{width:20px;height:20px;border-radius:50%;object-fit:cover;box-shadow:0 0 0 1px rgba(255,255,255,.14)}
    .kebab{
      width:34px;height:34px;
      border-radius:12px;
      background:rgba(0,0,0,.42);
      border:1px solid rgba(255,255,255,.16);
      color:#fff;
      display:flex;align-items:center;justify-content:center;
      position:absolute;top:10px;right:10px;
      font-size:18px;font-weight:900;
      cursor:pointer;user-select:none;
    }
    .kebab:hover{background:rgba(0,0,0,.60)}
    .kebab::before{content:"â‹®";display:block;transform:translateY(-1px)} /* ì¤‘ì•™ ë³´ì • */

    /* List item */
    .li{
      display:flex;gap:12px;align-items:center;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(28,28,30,.92);
      cursor:pointer;
      position:relative;
    }
    .li:hover{background:rgba(44,44,46,.92)}
    .li.active{outline:2px solid rgba(0,122,255,.85);outline-offset:-2px}
    .li-thumb{width:56px;height:56px;border-radius:14px;object-fit:cover;box-shadow:0 0 0 1px rgba(255,255,255,.12)}
    .li-mid{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}
    .li-title{font-weight:900;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .li-sub{font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .li-right{display:flex;align-items:center;gap:8px;color:var(--sub)}
    .li .kebab{position:static}

    /* Inline player */
    .player-block{
      width:100%;
      border-radius:var(--radius);
      overflow:hidden;
      background:#000;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 14px 34px rgba(0,0,0,.6);
      margin:8px 0 10px;
      position:relative;
    }
    #results.grid .player-block{grid-column:1/-1}
    .player-head{
      position:absolute;left:0;right:0;top:0;height:56px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:0 14px;
      background:linear-gradient(to bottom, rgba(0,0,0,.88), rgba(0,0,0,0));
      z-index:3;
      opacity:0;transform:translateY(-8px);pointer-events:none;transition:.16s ease;
    }
    .player-block:hover .player-head{opacity:1;transform:translateY(0);pointer-events:auto}
    .player-title{font-weight:900;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%}
    .player-actions{display:flex;gap:8px;align-items:center}
    .ghost{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
      padding:8px 10px;border-radius:12px;
      font-weight:900;cursor:pointer;
    }
    .ghost:hover{background:rgba(255,255,255,.14)}
    .player-frame{width:100%;height:clamp(420px, 60vw, 86vh);background:#000}
    #playerHost, #playerHost iframe{width:100%;height:100%;border:0;display:block}

    /* Load more */
    #loadMore{width:100%;margin-top:16px;padding:14px 18px;border-radius:14px;font-weight:900;display:none}

    /* Mini bar (YTM-ish) */
    #mini{
      position:fixed;left:0;right:0;bottom:0;height:66px;
      background:rgba(16,16,16,.92);
      backdrop-filter:blur(14px);
      border-top:1px solid rgba(255,255,255,.10);
      box-shadow:0 -14px 34px rgba(0,0,0,.55);
      z-index:1000;
      transform:translateY(110%);
      transition:transform .16s ease-out;
    }
    #mini.visible{transform:translateY(0)}
    .seek{position:absolute;left:0;right:0;top:0;height:3px;background:rgba(255,255,255,.14);cursor:pointer}
    .seekFill{height:100%;width:0%;background:var(--yt-red)}
    .miniRow{height:100%;display:flex;align-items:center;gap:12px;padding:10px 12px}
    .miniLeft{display:flex;align-items:center;gap:8px}
    .miniTime{color:var(--sub);font-size:12px;min-width:96px}
    .miniCenter{
      flex:1;min-width:0;display:flex;align-items:center;gap:10px;
      cursor:pointer;
    }
    .miniThumb{width:42px;height:42px;border-radius:12px;object-fit:cover;box-shadow:0 0 0 1px rgba(255,255,255,.10);background:rgba(255,255,255,.06)}
    .miniMeta{min-width:0}
    .miniTitle{font-size:13px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .miniSub{margin-top:2px;font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .miniRight{display:flex;align-items:center;gap:2px}
    .mbtn{background:transparent;border:0;color:#fff;padding:8px;border-radius:12px;cursor:pointer}
    .mbtn:hover{background:rgba(255,255,255,.10)}
    .mbtn.main{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.10)}
    .ico{width:18px;height:18px;fill:rgba(255,255,255,.92);display:block}
    @media (max-width:520px){.miniTime{display:none}}

    /* Queue sheet */
    #backdrop{position:fixed;inset:0;background:rgba(0,0,0,.40);opacity:0;pointer-events:none;transition:.16s ease;z-index:1100}
    #backdrop.visible{opacity:1;pointer-events:auto}
    #sheet{
      position:fixed;left:0;right:0;bottom:0;
      height:min(86vh, 820px);
      transform:translateY(100%);
      transition:transform .18s ease-out;
      z-index:1200;
      border-top-left-radius:22px;border-top-right-radius:22px;
      overflow:hidden;
      background:rgba(18,18,18,.94);
      backdrop-filter:blur(16px);
      border-top:1px solid rgba(255,255,255,.12);
      box-shadow:0 -20px 60px rgba(0,0,0,.65);
      display:flex;flex-direction:column;
    }
    #sheet.open{transform:translateY(0)}
    .handle{height:26px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02)}
    .handle::before{content:"";width:48px;height:5px;border-radius:999px;background:rgba(255,255,255,.22)}
    .sheetTop{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid rgba(255,255,255,.08)}
    .sheetTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sheetSub{margin-top:2px;font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sheetBody{flex:1;overflow:auto;padding:12px}
    .qcard{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);border-radius:16px;overflow:hidden}
    .qitem{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer}
    .qitem:last-child{border-bottom:0}
    .qitem:hover{background:rgba(255,255,255,.06)}
    .qitem.active{outline:2px solid rgba(255,0,0,.55);outline-offset:-2px;background:rgba(255,0,0,.08)}
    .qthumb{width:44px;height:44px;border-radius:12px;object-fit:cover;box-shadow:0 0 0 1px rgba(255,255,255,.10)}
    .qmid{flex:1;min-width:0}
    .qname{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .qart{margin-top:2px;font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .qright{display:flex;gap:6px}
    .ibtn{width:34px;height:34px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);color:#fff;cursor:pointer;font-weight:900}
    .ibtn:hover{background:rgba(255,255,255,.10)}

    /* Popover */
    #menuBg{position:fixed;inset:0;background:transparent;display:none;z-index:2000}
    #menuBg.visible{display:block}
    #menu{
      position:fixed;
      min-width:240px;max-width:320px;
      background:rgba(28,28,30,.96);
      backdrop-filter:blur(14px);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
      padding:10px;
      display:none;
      z-index:2001;
    }
    #menu.visible{display:block}
    .mtitle{font-size:12px;color:var(--sub);padding:6px 10px 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mitem{
      width:100%;text-align:left;background:transparent;border:0;color:#fff;
      padding:10px 10px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:900;
    }
    .mitem:hover{background:rgba(255,255,255,.10)}
    .msep{height:1px;background:rgba(255,255,255,.10);margin:8px 4px}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div style="min-width:260px">
      <div class="row" style="width:auto">
        <input type="password" id="apiKey" placeholder="YouTube API Key" />
        <button class="secondary" onclick="saveKey()">Key ì €ì¥</button>
        <button class="secondary" onclick="clearKey()">ì´ˆê¸°í™”</button>
        <select id="region" style="width:92px">
          <option value="KR" selected>KR</option>
          <option value="US">US</option>
          <option value="JP">JP</option>
          <option value="GB">GB</option>
          <option value="CA">CA</option>
          <option value="AU">AU</option>
        </select>

        <select id="goal" style="width:220px">
          <option value="trend" selected>íŠ¸ë Œë“œ/ì†Œì¬(ìµœì‹ )</option>
          <option value="hit">ê²€ì¦ëœ ëŒ€ë°•(ì¡°íšŒìˆ˜)</option>
          <option value="ref">ë ˆí¼ëŸ°ìŠ¤(ê´€ë ¨ì„±)</option>
          <option value="rate">ë°˜ì‘ì¢‹ìŒ(í‰ì )</option>
          <option value="speed">ê¸‰ìƒìŠ¹(ì†ë„ìˆœ)</option>
        </select>

        <input id="keyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" onkeypress="if(event.key==='Enter') searchVideos(true)" />
        <button onclick="searchVideos(true)">ê²€ìƒ‰</button>

        <button class="secondary" id="viewBtn" onclick="toggleView()">ë¦¬ìŠ¤íŠ¸</button>

        <label class="chk"><input type="checkbox" id="autoPlay">ìë™ì¬ìƒ</label>

        <label class="chk"><input type="checkbox" id="autoSuggest">ì—°ê´€ì¶”ì²œ</label>
      </div>
    </header>

    <div id="status" class="muted">ëŒ€ê¸° ì¤‘â€¦</div>

    <div id="results" class="grid">
      <div class="center">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  â€œê²€ìƒ‰â€ì„ ëˆ„ë¥´ì„¸ìš”.</div>
    </div>

    <button id="loadMore" class="secondary" onclick="searchVideos(false)">ë” ë³´ê¸° (ë‹¤ìŒ 50ê°œ)</button>
  </div>

  <!-- Mini player -->
  <div id="mini">
    <div id="seek" class="seek"><div id="seekFill" class="seekFill"></div></div>
    <div class="miniRow" id="miniRow">
      <div class="miniLeft">
        <button class="mbtn" onclick="prev()" title="ì´ì „">
          <svg viewBox="0 0 24 24" class="ico"><path d="M6 6h2v12H6V6zm3.5 6 10-6v12l-10-6z"/></svg>
        </button>
        <button class="mbtn main" onclick="togglePlay()" title="ì¬ìƒ/ì¼ì‹œì •ì§€">
          <svg viewBox="0 0 24 24" class="ico" id="playIco"><path d="M8 5v14l11-7L8 5z"/></svg>
        </button>
        <button class="mbtn" onclick="next()" title="ë‹¤ìŒ">
          <svg viewBox="0 0 24 24" class="ico"><path d="M16 6h2v12h-2V6zM7 18V6l10 6-10 6z"/></svg>
        </button>
        <div class="miniTime" id="time">0:00 / 0:00</div>
      </div>

      <div class="miniCenter" onclick="goToPlayback()" title="ì¬ìƒ ìœ„ì¹˜ë¡œ ì´ë™">
        <img id="mThumb" class="miniThumb" alt="">
        <div class="miniMeta">
          <div class="miniTitle" id="mTitle"></div>
          <div class="miniSub" id="mSub"></div>
        </div>
      </div>

      <div class="miniRight">
        <button class="mbtn" onclick="openQueue()" title="í">
          <svg viewBox="0 0 24 24" class="ico"><path d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h10v2H4v-2zm14 0h2v2h-2v-2z"/></svg>
        </button>
        <button class="mbtn" onclick="openNewTab()" title="ìƒˆ íƒ­">
          <svg viewBox="0 0 24 24" class="ico"><path d="M14 3h7v7h-2V6.4l-9.3 9.3-1.4-1.4L17.6 5H14V3zM5 5h6v2H7v10h10v-4h2v6H5V5z"/></svg>
        </button>
        <button class="mbtn" onclick="closePlayer()" title="ë‹«ê¸°">
          <svg viewBox="0 0 24 24" class="ico"><path d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3 1.4 1.4z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Queue sheet -->
  <div id="backdrop" onclick="closeQueue()"></div>
  <div id="sheet">
    <div class="handle"></div>
    <div class="sheetTop">
      <div style="min-width:0">
        <div class="sheetTitle" id="sTitle">í</div>
        <div class="sheetSub" id="sSub">â€”</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="secondary" onclick="clearQueue()">ë¹„ìš°ê¸°</button>
        <button class="secondary" onclick="closeQueue()">ë‹«ê¸°</button>
      </div>
    </div>
    <div class="sheetBody" id="qBody"></div>
  </div>

  <!-- Popover -->
  <div id="menuBg" onclick="closeMenu()"></div>
  <div id="menu">
    <div class="mtitle" id="mMenuTitle">ë©”ë‰´</div>
    <button class="mitem" onclick="menuAction('play')">â–¶ ì¬ìƒ</button>
    <button class="mitem" onclick="menuAction('addQueue')">â• íì— ì¶”ê°€</button>
    <button class="mitem" onclick="menuAction('playNext')">â­ ë‹¤ìŒì— ì¬ìƒ(í)</button>
    <button class=\"mitem\" onclick=\"menuAction('related')\">ğŸ” ì´ ê³¡ ê¸°ë°˜ ì¶”ì²œ</button>
    <div class="msep"></div>
    <button class="mitem" onclick="menuAction('hideVideo')">ğŸš« ì´ ì˜ìƒ ìˆ¨ê¸°ê¸°</button>
    <button class="mitem" onclick="menuAction('hideChannel')">ğŸš« ì´ ì±„ë„ ìˆ¨ê¸°ê¸°</button>
    <div class="msep"></div>
    <button class="mitem" onclick="menuAction('open')">â†— ìƒˆ íƒ­</button>
    <button class="mitem" onclick="menuAction('copyUrl')">ğŸ”— ë§í¬ ë³µì‚¬</button>
  </div>

<script>
  // ===== Helpers =====
  const $ = (id)=>document.getElementById(id);
  const escapeHtml = (t)=> (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  const fmtNum = (n)=>{ n=Number(n||0); if(n>=1e6) return (n/1e6).toFixed(1)+'M'; if(n>=1e3) return (n/1e3).toFixed(1)+'K'; return String(n); };
  const parseDuration = (d)=>{ const m=(d||'PT0S').match(/PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)S)?/); if(!m) return 0; return (parseInt(m[1]||0)*3600)+(parseInt(m[2]||0)*60)+parseInt(m[3]||0); };
  const fmtDur = (sec)=>{ sec=Math.max(0,sec|0); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; if(h>0) return h+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); return m+':'+String(s).padStart(2,'0'); };
  const setStatus = (t)=> $('status').innerText = t;
  const copyText = async (t)=>{ try{ await navigator.clipboard.writeText(t); }catch(e){ prompt('ë³µì‚¬:', t); } };

  function scrollToCenter(el){
    if(!el) return;
    const r=el.getBoundingClientRect();
    const target = window.scrollY + r.top + (r.height/2) - (window.innerHeight/2);
    window.scrollTo({ top: Math.max(0,target), behavior:'smooth' });
  }

  // ===== YouTube IFrame API =====
  let ytReady=false, player=null;
  window.onYouTubeIframeAPIReady = ()=>{ ytReady=true; };
  (function(){
    const tag=document.createElement('script');
    tag.src="https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
  })();

  // ===== State =====
  let API_KEY = localStorage.getItem('yt_api_key_lite') || '';
  if(API_KEY) $('apiKey').value = API_KEY;

  const AUTO_KEY='yt_autoplay_lite';
  const savedAuto=localStorage.getItem(AUTO_KEY);
  if(savedAuto!==null) $('autoPlay').checked = (savedAuto==='1');
  $('autoPlay').addEventListener('change', ()=> localStorage.setItem(AUTO_KEY, $('autoPlay').checked?'1':'0'));


  const SUGGEST_KEY='yt_autosuggest_lite';
  const savedSuggest=localStorage.getItem(SUGGEST_KEY);
  if(savedSuggest!==null) $('autoSuggest').checked = (savedSuggest==='1');
  $('autoSuggest').addEventListener('change', ()=> localStorage.setItem(SUGGEST_KEY, $('autoSuggest').checked?'1':'0'));
  let viewMode = localStorage.getItem('yt_view_mode') || 'grid';
  let currentData=[], nextPageToken=null, currentQuery={}, activeIndex=-1;
  let isLoading=false;

  let currentVideo={ id:'', title:'', channel:'', thumb:'', url:'' };
  let queue=[], queuePos=-1;
  let blockedVideos=new Set(JSON.parse(localStorage.getItem('yt_block_v')||'[]'));
  let blockedChannels=new Set(JSON.parse(localStorage.getItem('yt_block_c')||'[]'));

  // ===== UI init =====
  function updateViewBtn(){
    $('results').className = viewMode;
    $('viewBtn').innerText = (viewMode==='grid') ? 'ë¦¬ìŠ¤íŠ¸' : 'ê·¸ë¦¬ë“œ';
  }
  updateViewBtn();

  function saveKey(){
    const k=$('apiKey').value.trim();
    if(!k) return alert('API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    API_KEY=k;
    localStorage.setItem('yt_api_key_lite',k);
    alert('ì €ì¥ ì™„ë£Œ');
  }
  function clearKey(){
    localStorage.removeItem('yt_api_key_lite');
    API_KEY=''; $('apiKey').value='';
  }
  function toggleView(){
    viewMode = (viewMode==='grid') ? 'list' : 'grid';
    localStorage.setItem('yt_view_mode', viewMode);
    updateViewBtn();
    renderFull();
    placeInlinePlayer();
  }

  // ===== Order mapping =====
  function goalToOrder(goal){
    if(goal==='trend') return 'date';
    if(goal==='hit') return 'viewCount';
    if(goal==='ref') return 'relevance';
    if(goal==='rate') return 'rating';
    if(goal==='speed') return 'date';
    return 'relevance';
  }
  function goalLabel(goal){
    if(goal==='trend') return 'íŠ¸ë Œë“œ/ì†Œì¬(ìµœì‹ ìˆœ)';
    if(goal==='hit') return 'ê²€ì¦ëœ ëŒ€ë°•(ì¡°íšŒìˆ˜ìˆœ)';
    if(goal==='ref') return 'ë ˆí¼ëŸ°ìŠ¤(ê´€ë ¨ì„±)';
    if(goal==='rate') return 'ë°˜ì‘ì¢‹ìŒ(í‰ì ìˆœ)';
    if(goal==='speed') return 'ê¸‰ìƒìŠ¹(ì†ë„ìˆœ: ë¡œì»¬ì •ë ¬)';
    return 'ë ˆí¼ëŸ°ìŠ¤(ê´€ë ¨ì„±)';
  }

  // ===== Search =====
  async function fetchJson(url){
    const res = await fetch(url);
    const json = await res.json();
    if(json && json.error) throw new Error(json.error.message || 'YouTube API ì˜¤ë¥˜');
    return json;
  }

  function updateLoadMoreUI(){
    const btn=$('loadMore');
    if(nextPageToken){
      btn.style.display='block';
      btn.disabled=isLoading;
      btn.innerText = isLoading ? 'ë¡œë”© ì¤‘...' : 'ë” ë³´ê¸° (ë‹¤ìŒ 50ê°œ)';
    }else{
      btn.style.display='none';
    }
  }

  async function searchVideos(isNew){
    if(!API_KEY) return alert('API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    if(isLoading) return;

    let q, region, goal, order;
    if(isNew){
      q=$('keyword').value.trim();
      if(!q) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      region=$('region').value;
      goal=$('goal').value;
      order=goalToOrder(goal);
      currentQuery={q,region,goal,order};
      nextPageToken=null;
      currentData=[];
      activeIndex=-1;
      removeInlinePlayer(false); // ìƒˆê²€ìƒ‰ì´ë©´ í”Œë ˆì´ì–´ ë‹«ê¸°
      $('results').innerHTML='';
      setStatus('ê²€ìƒ‰ ì¤‘â€¦');
    }else{
      if(!nextPageToken) return;
      ({q,region,goal,order}=currentQuery);
      setStatus('ë‹¤ìŒ ê²°ê³¼ ë¡œë”© ì¤‘â€¦');
    }

    isLoading=true;
    updateLoadMoreUI();

    try{
      let sUrl='https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=50'
        +'&q='+encodeURIComponent(q)
        +'&regionCode='+encodeURIComponent(region)
        +'&order='+encodeURIComponent(order)
        +'&key='+encodeURIComponent(API_KEY);
      if(!isNew && nextPageToken) sUrl+='&pageToken='+encodeURIComponent(nextPageToken);

      const sJson=await fetchJson(sUrl);
      nextPageToken=sJson.nextPageToken||null;
      updateLoadMoreUI();

      const items=(sJson.items||[]).filter(x=>x?.id?.videoId);
      if(isNew && !items.length){
        $('results').innerHTML='<div class="center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        setStatus('0ê°œ Â· '+region+' Â· '+goalLabel(goal)+' (order='+order+')');
        return;
      }
      if(!items.length && !isNew) return;

      const ids=items.map(x=>x.id.videoId).join(',');
      const vUrl='https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id='+encodeURIComponent(ids)+'&key='+encodeURIComponent(API_KEY);
      const vJson=await fetchJson(vUrl);
      const detMap=new Map();
      (vJson.items||[]).forEach(v=>detMap.set(v.id,v));

      const chIds=[...new Set(items.map(x=>x.snippet?.channelId).filter(Boolean))].slice(0,50);
      const chIconMap=new Map();
      if(chIds.length){
        const cUrl='https://www.googleapis.com/youtube/v3/channels?part=snippet&id='+encodeURIComponent(chIds.join(','))+'&key='+encodeURIComponent(API_KEY);
        const cJson=await fetchJson(cUrl);
        (cJson.items||[]).forEach(ch=>{
          const th=ch.snippet?.thumbnails||{};
          const url=(th.default?.url)||(th.medium?.url)||(th.high?.url)||'';
          chIconMap.set(ch.id,url);
        });
      }

      const seen=new Set(currentData.map(x=>x.id));
      const newCards=[];
      for(const it of items){
        const vid=it.id.videoId;
        if(seen.has(vid)) continue;
        if(blockedVideos.has(vid)) continue;

        const sn=it.snippet||{};
        const chId=sn.channelId||'';
        if(blockedChannels.has(chId)) continue;

        const det=detMap.get(vid);
        const publishedAt=new Date(sn.publishedAt||Date.now());
        const viewCount=det ? Number(det.statistics?.viewCount||0) : 0;
        const hours=Math.max(0.25,(Date.now()-publishedAt.getTime())/36e5);
        const viewsPerHour=viewCount/hours;

        newCards.push({
          id:vid,
          title:sn.title||'',
          channelTitle:sn.channelTitle||'',
          channelId:chId,
          channelIcon:chIconMap.get(chId)||'',
          publishedDate:(sn.publishedAt||'').slice(0,10),
          thumbnail:(sn.thumbnails?.high?.url)||(sn.thumbnails?.medium?.url)||'',
          durationSec: det ? parseDuration(det.contentDetails?.duration||'PT0S') : 0,
          viewCount,
          viewsPerHour
        });
        seen.add(vid);
      }

      const startIndex=currentData.length;
      currentData=currentData.concat(newCards);

      if(currentQuery.goal==='speed'){
        // speedëŠ” ì „ì²´ ì •ë ¬ í•„ìš” â†’ í’€ ë Œë” (í”Œë ˆì´ì–´ ìœ ì§€)
        const playingId=currentVideo.id;
        currentData.sort((a,b)=>(b.viewsPerHour||0)-(a.viewsPerHour||0));
        if(playingId){
          const ni=currentData.findIndex(v=>v.id===playingId);
          if(ni>=0) activeIndex=ni;
        }
        renderFull();
        placeInlinePlayer();
      }else{
        if(isNew){
          renderFull();
        }else{
          appendCards(newCards, startIndex);
        }
      }

      setStatus('ê²°ê³¼: '+currentData.length+'ê°œ Â· '+currentQuery.region+' Â· '+goalLabel(currentQuery.goal)+' (order='+currentQuery.order+')');

    }catch(e){
      console.error(e);
      setStatus('ì˜¤ë¥˜');
      $('results').innerHTML='<div class="center">ì˜¤ë¥˜: '+escapeHtml(e.message)+'</div>';
      nextPageToken=null;
    }finally{
      isLoading=false;
      updateLoadMoreUI();
      observeInlineVisibility();
    }
  }

  // ===== Related / Style-ish recommendations =====
  // NOTE: YouTube Data APIëŠ” 'ì¥ë¥´'ë¥¼ ì§ì ‘ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
  // ëŒ€ì‹  relatedToVideoId(ì—°ê´€ ì˜ìƒ) + Music ì¹´í…Œê³ ë¦¬(10) í•„í„°ë¡œ "ë¹„ìŠ·í•œ ìŠ¤íƒ€ì¼"ì„ ìœ ì‚¬í•˜ê²Œ êµ¬ì„±í•©ë‹ˆë‹¤.
  async function refreshRelated(){
    if(!currentVideo.id){ alert('ë¨¼ì € ì˜ìƒì„ ì¬ìƒí•˜ì„¸ìš”.'); return; }
    await searchRelatedById(currentVideo.id, true);
  }

    async function searchRelatedById(videoId, isNew){
    if(!API_KEY) return alert('API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    if(isLoading) return;
    const region=$('region').value;

    if(isNew){
      // ê¸°ì¡´ ê²€ìƒ‰ UIë¥¼ "ì¶”ì²œ ëª¨ë“œ"ë¡œ ë°”ê¾¸ê¸°
      currentQuery={ mode:'related', q:'', relatedToVideoId: videoId, region, goal:'ref', order:'relevance', relatedMusicOnly:true };
      nextPageToken=null;
      currentData=[];
      activeIndex=-1;
      // í”Œë ˆì´ì–´ëŠ” ìœ ì§€í•˜ê³  ë¦¬ìŠ¤íŠ¸ë§Œ êµì²´
      $('results').innerHTML='';
      setStatus('ì—°ê´€ ì¶”ì²œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
    }else{
      if(!nextPageToken) return;
      setStatus('ì—°ê´€ ì¶”ì²œ ë” ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
    }

    isLoading=true;
    updateLoadMoreUI();

    try{
      // relatedToVideoIdëŠ” qì™€ ê°™ì´ ëª» ì”ë‹ˆë‹¤. (YouTubeê°€ ì œê³µí•˜ëŠ” "ì—°ê´€ ì˜ìƒ" ê¸°ë°˜)
      const base='https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=50'
        +'&relatedToVideoId='+encodeURIComponent(videoId)
        +'&regionCode='+encodeURIComponent(region)
        +'&order=relevance';

      const makeUrl=(musicOnly, pageToken)=>(
        base
        + (musicOnly ? '&videoCategoryId=10' : '') // Music filter (ë„ˆë¬´ ê²°ê³¼ê°€ ì ìœ¼ë©´ ìë™ìœ¼ë¡œ í•´ì œ)
        + (pageToken ? '&pageToken='+encodeURIComponent(pageToken) : '')
        + '&key='+encodeURIComponent(API_KEY)
      );

      // 1) ê¸°ë³¸ì€ Musicë§Œìœ¼ë¡œ ë¨¼ì € ì‹œë„
      let sJson = await fetchJson(makeUrl(!!currentQuery.relatedMusicOnly, (!isNew ? nextPageToken : null)));
      let items=(sJson.items||[]).filter(x=>x?.id?.videoId);

      // 2) ê²°ê³¼ê°€ ë„ˆë¬´ ì ìœ¼ë©´(íŠ¹íˆ í•´ì™¸/ë¹„ìŒì› ì˜ìƒ) Music í•„í„°ë¥¼ ìë™ í•´ì œí•˜ê³  ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
      if(isNew && currentQuery.relatedMusicOnly && items.length < 8){
        currentQuery.relatedMusicOnly = false;
        sJson = await fetchJson(makeUrl(false, null));
        items=(sJson.items||[]).filter(x=>x?.id?.videoId);
      }

      nextPageToken=sJson.nextPageToken||null;
      updateLoadMoreUI();

      if(isNew && !items.length){
        $('results').innerHTML='<div class="center">ì—°ê´€ ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        setStatus('0ê°œ Â· '+region+' Â· ì—°ê´€ ì¶”ì²œ');
        return;
      }
      if(!items.length && !isNew) return;

      const ids=items.map(x=>x.id.videoId).join(',');
      const vUrl='https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id='+encodeURIComponent(ids)+'&key='+encodeURIComponent(API_KEY);
      const vJson=await fetchJson(vUrl);
      const detMap=new Map();
      (vJson.items||[]).forEach(v=>detMap.set(v.id,v));

      const chIds=[...new Set(items.map(x=>x.snippet?.channelId).filter(Boolean))].slice(0,50);
      const chIconMap=new Map();
      if(chIds.length){
        const cUrl='https://www.googleapis.com/youtube/v3/channels?part=snippet&id='+encodeURIComponent(chIds.join(','))+'&key='+encodeURIComponent(API_KEY);
        const cJson=await fetchJson(cUrl);
        (cJson.items||[]).forEach(ch=>{
          const th=ch.snippet?.thumbnails||{};
          const url=(th.default?.url)||(th.medium?.url)||(th.high?.url)||'';
          chIconMap.set(ch.id,url);
        });
      }

      const seen=new Set(currentData.map(x=>x.id));
      const newCards=[];
      for(const it of items){
        const vid=it.id.videoId;
        if(seen.has(vid)) continue;
        if(blockedVideos.has(vid)) continue;

        const sn=it.snippet||{};
        const chId=sn.channelId||'';
        if(blockedChannels.has(chId)) continue;

        const det=detMap.get(vid);
        const publishedAt=new Date(sn.publishedAt||Date.now());
        const viewCount=det ? Number(det.statistics?.viewCount||0) : 0;
        const hours=Math.max(0.25,(Date.now()-publishedAt.getTime())/36e5);
        const viewsPerHour=viewCount/hours;

        newCards.push({
          id:vid,
          title:sn.title||'',
          channelTitle:sn.channelTitle||'',
          channelId:chId,
          channelIcon:chIconMap.get(chId)||'',
          publishedDate:(sn.publishedAt||'').slice(0,10),
          thumbnail:(sn.thumbnails?.high?.url)||(sn.thumbnails?.medium?.url)||'',
          durationSec: det ? parseDuration(det.contentDetails?.duration||'PT0S') : 0,
          viewCount,
          viewsPerHour
        });
        seen.add(vid);
      }

      const startIndex=currentData.length;
      currentData=currentData.concat(newCards);

      // ì¶”ì²œ ëª¨ë“œëŠ” relevance ê¸°ë°˜ì´ë‹ˆ ì •ë ¬ì€ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
      if(isNew) renderFull();
      else appendCards(newCards, startIndex);

      const hint = currentQuery.relatedMusicOnly ? '(Music í•„í„°)' : '(í•„í„° í•´ì œ)';
      setStatus('ì—°ê´€ ì¶”ì²œ: '+currentData.length+'ê°œ Â· '+region+' Â· '+hint);
    }catch(e){
      console.error(e);
      setStatus('ì˜¤ë¥˜');
      $('results').innerHTML='<div class="center">ì˜¤ë¥˜: '+escapeHtml(e.message)+'</div>';
      nextPageToken=null;
    }finally{
      isLoading=false;
      updateLoadMoreUI();
      observeInlineVisibility();
    }
  }


  // ===== Render =====
  function cardHTML(v, idx){
    const vph=Math.round(v.viewsPerHour||0);
    const vphText = vph>=1000 ? (vph/1000).toFixed(1)+'K/h' : vph+'/h';
    const speedChip = (currentQuery.goal==='speed') ? `<span class="chip">ì†ë„ ${vphText}</span>` : '';
    return `
      <div class="card ${idx===activeIndex?'active':''}" data-idx="${idx}" onclick="onItemClick(${idx})">
        <div class="thumb">
          <img src="${v.thumbnail}" alt="">
          <div class="kebab" onclick="openMenu(event, ${idx})"></div>
          <div class="dur">${fmtDur(v.durationSec)}</div>
        </div>
        <div class="body">
          <div class="title" title="${escapeHtml(v.title)}">${escapeHtml(v.title)}</div>
          <div class="meta">
            <div class="ch-row">
              ${v.channelIcon?`<img class="ch-fav" src="${v.channelIcon}" alt="">`:''}
              <span>${escapeHtml(v.channelTitle)}</span>
            </div>
          </div>
          <div class="meta">
            <span class="chip">ì¡°íšŒ ${fmtNum(v.viewCount)}</span>
            <span class="chip">${v.publishedDate||'-'}</span>
            ${speedChip}
          </div>
        </div>
      </div>
    `;
  }
  function listHTML(v, idx){
    return `
      <div class="li ${idx===activeIndex?'active':''}" data-idx="${idx}" onclick="onItemClick(${idx})">
        <img class="li-thumb" src="${v.thumbnail}" alt="">
        <div class="li-mid">
          <div class="li-title" title="${escapeHtml(v.title)}">${escapeHtml(v.title)}</div>
          <div class="li-sub">${escapeHtml(v.channelTitle)} Â· ${fmtDur(v.durationSec)} Â· ì¡°íšŒ ${fmtNum(v.viewCount)} Â· ${v.publishedDate||'-'}</div>
        </div>
        <div class="li-right">
          <div class="kebab" onclick="openMenu(event, ${idx})"></div>
        </div>
      </div>
    `;
  }

  function renderFull(){
    const el=$('results');
    el.className=viewMode;
    if(!currentData.length){
      el.innerHTML='<div class="center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    let html='';
    for(let i=0;i<currentData.length;i++){
      const v=currentData[i];
      if(blockedVideos.has(v.id) || blockedChannels.has(v.channelId)) continue;
      html += (viewMode==='grid') ? cardHTML(v,i) : listHTML(v,i);
    }
    el.innerHTML = html || '<div class="center">í‘œì‹œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤(ì°¨ë‹¨ í•„í„°).</div>';
  }

  function appendCards(newCards, startIndex){
    const el=$('results');
    if(!newCards.length) return;

    let html='';
    for(let i=0;i<newCards.length;i++){
      const idx=startIndex+i;
      const v=newCards[i];
      if(blockedVideos.has(v.id) || blockedChannels.has(v.channelId)) continue;
      html += (viewMode==='grid') ? cardHTML(v, idx) : listHTML(v, idx);
    }
    if(!html) return;
    el.insertAdjacentHTML('beforeend', html);
  }

  // ===== Inline player placement =====
  function ensureInlinePlayer(){
    let block=$('inlinePlayer');
    if(block) return block;

    block=document.createElement('div');
    block.id='inlinePlayer';
    block.className='player-block';
    block.innerHTML=`
      <div class="player-head">
        <div class="player-title" id="pTitle">ì¬ìƒ</div>
        <div class="player-actions">
          <button class="ghost" onclick="openQueue()">í</button>
          <button class="ghost" onclick="refreshRelated()">ì—°ê´€</button>
          <button class="ghost" onclick="openNewTab()">ìƒˆ íƒ­</button>
          <button class="ghost" onclick="closePlayer()">ë‹«ê¸°</button>
        </div>
      </div>
      <div class="player-frame"><div id="playerHost"></div></div>
    `;
    return block;
  }

  function calcCols(){
    const el=$('results');
    const styles=getComputedStyle(el);
    const gap=parseFloat(styles.gap||'16')||16;
    const minCard=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--minCard'))||300;
    const w=el.clientWidth||1;
    return Math.max(1, Math.floor((w+gap)/(minCard+gap)));
  }

  function placeInlinePlayer(){
    const block=$('inlinePlayer');
    if(!block || activeIndex<0) return;

    const el=$('results');

    if(viewMode==='list'){
      const items=Array.from(el.querySelectorAll('.li'));
      const anchor=items.find(x=>Number(x.dataset.idx)===activeIndex);
      if(anchor && anchor.parentNode) anchor.insertAdjacentElement('afterend', block);
      else el.appendChild(block);
      return;
    }

    const cols=calcCols();
    const rowStart=Math.floor(activeIndex/cols)*cols;
    const rowEnd=Math.min(currentData.length-1, rowStart+cols-1);

    const cards=Array.from(el.querySelectorAll('.card'));
    const anchor=cards.find(x=>Number(x.dataset.idx)===rowEnd);
    if(anchor && anchor.parentNode) anchor.insertAdjacentElement('afterend', block);
    else el.appendChild(block);
  }

  // ===== Player update =====
  function buildQueueFromVisible(clickedId){
    // íëŠ” "í˜„ì¬ ë³´ì´ëŠ”(ì°¨ë‹¨ ì œì™¸) ê²°ê³¼" ê¸°ë°˜
    const visible=[];
    for(const v of currentData){
      if(blockedVideos.has(v.id) || blockedChannels.has(v.channelId)) continue;
      visible.push({ id:v.id, title:v.title, channel:v.channelTitle, thumb:v.thumbnail });
    }
    queue = visible;
    queuePos = visible.findIndex(x=>x.id===clickedId);
    if(queuePos<0) queuePos=0;
    persistBlocks(); // also keeps localStorage in sync
  }

  function updateMiniMeta(){
    $('mTitle').innerText = currentVideo.title || '';
    $('mSub').innerText = currentVideo.channel || '';
    const img=$('mThumb');
    if(currentVideo.thumb){ img.src=currentVideo.thumb; img.style.visibility='visible'; }
    else{ img.removeAttribute('src'); img.style.visibility='hidden'; }
  }

  function updatePlayIcon(){
    const ico=$('playIco');
    if(!ico) return;
    if(!player || typeof player.getPlayerState!=='function' || typeof YT==='undefined') return;
    const st=player.getPlayerState();
    if(st===YT.PlayerState.PLAYING){
      ico.innerHTML='<path d="M6 5h4v14H6V5zm8 0h4v14h-4V5z"></path>';
    }else{
      ico.innerHTML='<path d="M8 5v14l11-7L8 5z"></path>';
    }
  }

  function updateMiniVisibility(){
    const mini=$('mini');
    // inlineì´ í™”ë©´ì— ë³´ì´ë©´ mini ìˆ¨ê¹€, ì•„ë‹ˆë©´ í‘œì‹œ
    const inline=$('inlinePlayer');
    if(!inline || activeIndex<0 || !currentVideo.id){
      mini.classList.toggle('visible', !!currentVideo.id);
      return;
    }
    // observerì—ì„œ ì²˜ë¦¬
  }

  let visObserver=null;
  function observeInlineVisibility(){
    if(visObserver){ visObserver.disconnect(); visObserver=null; }
    const inline=$('inlinePlayer');
    if(!inline){ updateMiniVisibility(); return; }
    visObserver = new IntersectionObserver((entries)=>{
      const ent=entries[0];
      const visible = ent && ent.isIntersecting && ent.intersectionRatio>0.2;
      $('mini').classList.toggle('visible', !visible && !!currentVideo.id);
    }, { root:null, threshold:[0,0.2,0.4] });
    visObserver.observe(inline);
  }

  let raf=0;
  function startMiniTicker(){
    if(raf) return;
    const tick=()=>{
      if(player && typeof player.getCurrentTime==='function' && typeof player.getDuration==='function'){
        const cur=player.getCurrentTime()||0;
        const dur=player.getDuration()||0;
        $('time').innerText = fmtDur(cur)+' / '+fmtDur(dur);
        $('seekFill').style.width = (dur>0 ? Math.min(100,(cur/dur)*100) : 0) + '%';
      }
      raf=requestAnimationFrame(tick);
    };
    tick();
  }
  function stopMiniTicker(){ if(raf){ cancelAnimationFrame(raf); raf=0; } }
  function updateInlinePlayer(v, userGesture=true){
    const titleEl=$('pTitle');
    if(titleEl) titleEl.innerText = v.title || 'ì¬ìƒ';

    currentVideo = { id:v.id, title:v.title, channel:v.channelTitle, thumb:v.thumbnail, url:'https://www.youtube.com/watch?v='+v.id };
    updateMiniMeta();

    if(!ytReady || typeof YT==='undefined' || !YT.Player) return;

    const shouldPlay = userGesture || $('autoPlay').checked;

    // âœ… ì´ë¯¸ í”Œë ˆì´ì–´ê°€ ìˆìœ¼ë©´: íŒŒê´´í•˜ì§€ ë§ê³  ì˜ìƒë§Œ êµì²´
    if(player && typeof player.loadVideoById === 'function'){
      try{
        if(shouldPlay){
          player.loadVideoById({ videoId: v.id });
          // ì¼ë¶€ í™˜ê²½ ë³´ì •
          try{ player.playVideo(); }catch(_){}
        }else{
          // ìë™ì¬ìƒ OFF ìƒíƒœì—ì„œëŠ” íë§Œ í•´ë‘ê¸°
          if(typeof player.cueVideoById === 'function') player.cueVideoById({ videoId: v.id });
          else player.loadVideoById({ videoId: v.id });
        }
      }catch(e){}
      updatePlayIcon();
      return;
    }

    // âœ… ì²˜ìŒ ìƒì„±ë  ë•Œë§Œ new YT.Player
    player = new YT.Player('playerHost', {
      videoId: v.id,
      playerVars: {
        autoplay: shouldPlay ? 1 : 0,
        rel: 0,
        playsinline: 1,
        origin: (location.origin && location.origin !== 'null') ? location.origin : ''
      },
      events:{
        onReady: (e)=>{
          updatePlayIcon(); startMiniTicker(); observeInlineVisibility();
          if(shouldPlay){
            try{ e.target.playVideo(); }catch(_){}
          }
        },
        onStateChange: (e)=>{
          updatePlayIcon();
          if(typeof YT!=='undefined' && e.data===YT.PlayerState.ENDED) next(true);
        }
      }
    });
  }


  // ===== Click item =====
  function onItemClick(idx){
    const v=currentData[idx];
    if(!v) return;

    activeIndex=idx;
    // active highlight only (no full re-render on loadMore)
    document.querySelectorAll('.active').forEach(el=>el.classList.remove('active'));
    const el = document.querySelector('[data-idx="'+idx+'"]');
    if(el) el.classList.add('active');

    buildQueueFromVisible(v.id);

    const results=$('results');
    const block=ensureInlinePlayer();

    // âœ… ìœ íŠœë¸Œ í”Œë ˆì´ì–´ëŠ” DOMì„ ê³„ì† ì˜®ê¸°ë©´(iframe ì´ë™) í™˜ê²½ì— ë”°ë¼ ì œì–´ê°€ ê¼¬ì¼ ìˆ˜ ìˆì–´,
    //    ì²« ìƒì„± ë•Œë§Œ "ì¸ë¼ì¸ ë°°ì¹˜", ì´í›„ì—ëŠ” ìœ„ì¹˜ ê³ ì •(ìŠ¤í¬ë¡¤ë§Œ ì´ë™)ìœ¼ë¡œ ì•ˆì •í™”í•©ë‹ˆë‹¤.
    const canMoveInline = !player; // ì•„ì§ í”Œë ˆì´ì–´ê°€ ì—†ì„ ë•Œë§Œ ì´ë™
    if(!block.parentNode) results.appendChild(block);

    if(canMoveInline){
      if(viewMode==='list'){
        const items=Array.from(results.querySelectorAll('.li'));
        const anchor=items.find(x=>Number(x.dataset.idx)===idx);
        if(anchor && anchor.parentNode) anchor.insertAdjacentElement('afterend', block);
        else results.appendChild(block);
      }else{
        const cols=calcCols();
        const rowStart=Math.floor(idx/cols)*cols;
        const rowEnd=Math.min(currentData.length-1, rowStart+cols-1);
        const cards=Array.from(results.querySelectorAll('.card'));
        const anchor=cards.find(x=>Number(x.dataset.idx)===rowEnd);
        if(anchor && anchor.parentNode) anchor.insertAdjacentElement('afterend', block);
        else results.appendChild(block);
      }
    }

    requestAnimationFrame(()=>{
      updateInlinePlayer(v, true); // í´ë¦­ì€ í•­ìƒ userGestureë¡œ ì¬ìƒ
      setTimeout(()=>scrollToCenter(block), 60);
    });
  }


  // ===== Mini controls =====
  function togglePlay(){
    if(!player || typeof player.getPlayerState!=='function' || typeof YT==='undefined') return;
    const st=player.getPlayerState();
    if(st===YT.PlayerState.PLAYING) player.pauseVideo();
    else player.playVideo();
  }
  function prev(isAuto=false){
    if(!queue.length) return;
    if(isAuto && !$('autoPlay').checked) return;
    if(queuePos>0) queuePos--;
    playQueuePos(!isAuto);
  }

  function next(isAuto=false){
    if(!queue.length) return;
    if(isAuto && !$('autoPlay').checked) return;
    if(queuePos < queue.length-1) queuePos++;
    playQueuePos(!isAuto);
  }

  function playQueuePos(userGesture=true){
    const t=queue[queuePos];
    if(!t) return;

    // currentDataì—ì„œ ì°¾ìœ¼ë©´ ê·¸ idxë¡œ ì´ë™
    const idx=currentData.findIndex(v=>v.id===t.id);
    if(idx>=0){
      onItemClick(idx); // onItemClick ìì²´ê°€ userGesture=trueë¡œ ì¬ìƒ ì²˜ë¦¬
      return;
    }

    // fallback: ê·¸ëƒ¥ ì¬ìƒ
    const block=ensureInlinePlayer();
    $('results').appendChild(block);
    activeIndex=-1;
    updateInlinePlayer({ id:t.id, title:t.title, channelTitle:t.channel, thumbnail:t.thumb }, userGesture);
    scrollToCenter(block);
  }


  $('seek').addEventListener('click', (e)=>{
    if(!player || typeof player.getDuration!=='function' || typeof player.seekTo!=='function') return;
    const rect=e.currentTarget.getBoundingClientRect();
    const x=Math.min(rect.width, Math.max(0, e.clientX-rect.left));
    const dur=player.getDuration()||0;
    if(dur<=0) return;
    player.seekTo((x/rect.width)*dur, true);
  });

  function goToPlayback(){
    const block=$('inlinePlayer');
    if(block) scrollToCenter(block);
  }
  function openNewTab(){ if(currentVideo.url) window.open(currentVideo.url,'_blank','noopener'); }
  function closePlayer(){ removeInlinePlayer(true); }

  function removeInlinePlayer(clearSelection){
    const block=$('inlinePlayer');
    if(block) block.remove();
    if(player && typeof player.destroy==='function'){ try{ player.destroy(); }catch(e){} }
    player=null;
    stopMiniTicker();

    if(clearSelection){
      document.querySelectorAll('.active').forEach(el=>el.classList.remove('active'));
      activeIndex=-1;
      currentVideo={ id:'', title:'', channel:'', thumb:'', url:'' };
      $('mini').classList.remove('visible');
    }else{
      // keep mini if there's a current video
      updateMiniMeta();
      $('mini').classList.toggle('visible', !!currentVideo.id);
    }
    observeInlineVisibility();
  }

  // ===== Queue sheet =====
  function openQueue(){
    renderQueue();
    $('backdrop').classList.add('visible');
    $('sheet').classList.add('open');
  }
  function closeQueue(){
    $('backdrop').classList.remove('visible');
    $('sheet').classList.remove('open');
  }
  function clearQueue(){
    queue=[]; queuePos=-1;
    renderQueue();
  }
  function renderQueue(){
    $('sTitle').innerText = 'í';
    $('sSub').innerText = queue.length ? (queue.length+'ê°œ') : 'ë¹„ì–´ìˆìŒ';
    const body=$('qBody');
    if(!queue.length){
      body.innerHTML='<div class="center" style="padding:22px 10px">íê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.</div>';
      return;
    }
    let html='<div class="qcard">';
    for(let i=0;i<queue.length;i++){
      const q=queue[i];
      html += `
        <div class="qitem ${i===queuePos?'active':''}" onclick="queuePlay(${i})">
          <img class="qthumb" src="${q.thumb}" alt="">
          <div class="qmid">
            <div class="qname">${escapeHtml(q.title)}</div>
            <div class="qart">${escapeHtml(q.channel)}</div>
          </div>
          <div class="qright">
            <button class="ibtn" onclick="event.stopPropagation(); queueMove(${i}, ${Math.max(0,i-1)})">â†‘</button>
            <button class="ibtn" onclick="event.stopPropagation(); queueMove(${i}, ${Math.min(queue.length-1,i+1)})">â†“</button>
            <button class="ibtn" onclick="event.stopPropagation(); queueDel(${i})">âœ•</button>
          </div>
        </div>
      `;
    }
    html+='</div>';
    body.innerHTML=html;
  }
  function queuePlay(i){ queuePos=i; playQueuePos(); renderQueue(); }
  function queueDel(i){
    if(i<0||i>=queue.length) return;
    queue.splice(i,1);
    if(queuePos>i) queuePos--;
    if(queuePos>=queue.length) queuePos=queue.length-1;
    renderQueue();
  }
  function queueMove(from,to){
    if(from===to) return;
    if(from<0||to<0||from>=queue.length||to>=queue.length) return;
    const [it]=queue.splice(from,1);
    queue.splice(to,0,it);
    if(queuePos===from) queuePos=to;
    else if(from<queuePos && to>=queuePos) queuePos--;
    else if(from>queuePos && to<=queuePos) queuePos++;
    renderQueue();
  }

  // ===== Popover menu =====
  let menuIndex=-1;
  function openMenu(ev, idx){
    ev.stopPropagation();
    menuIndex=idx;
    const v=currentData[idx];
    $('mMenuTitle').innerText = v ? v.title : 'ë©”ë‰´';

    const bg=$('menuBg'), menu=$('menu');
    bg.classList.add('visible'); menu.classList.add('visible');

    // position near button
    const btn=ev.currentTarget.getBoundingClientRect();
    const mr=menu.getBoundingClientRect();
    const pad=10, vw=innerWidth, vh=innerHeight;

    let left = btn.right - mr.width;
    let top = btn.bottom + 8;
    if(top + mr.height > vh - pad) top = btn.top - mr.height - 8;
    left = Math.min(vw-mr.width-pad, Math.max(pad,left));
    top  = Math.min(vh-mr.height-pad, Math.max(pad,top));

    menu.style.left = left+'px';
    menu.style.top  = top+'px';
  }
  function closeMenu(){
    $('menuBg').classList.remove('visible');
    $('menu').classList.remove('visible');
    menuIndex=-1;
  }
  function persistBlocks(){
    localStorage.setItem('yt_block_v', JSON.stringify([...blockedVideos]));
    localStorage.setItem('yt_block_c', JSON.stringify([...blockedChannels]));
  }
  function menuAction(act){
    const v=currentData[menuIndex];
    if(!v){ closeMenu(); return; }
    const url='https://www.youtube.com/watch?v='+v.id;

    if(act==='play'){ closeMenu(); onItemClick(menuIndex); return; }

    if(act==='addQueue'){
      queue.push({ id:v.id, title:v.title, channel:v.channelTitle, thumb:v.thumbnail });
      if(queuePos<0) queuePos=0;
      renderQueue();
      closeMenu();
      return;
    }
    if(act==='playNext'){
      if(queuePos<0){ queue.push({ id:v.id, title:v.title, channel:v.channelTitle, thumb:v.thumbnail }); queuePos=0; }
      else queue.splice(queuePos+1, 0, { id:v.id, title:v.title, channel:v.channelTitle, thumb:v.thumbnail });
      renderQueue();
      closeMenu();
      return;
    }

    if(act==='hideVideo'){
      blockedVideos.add(v.id);
      persistBlocks();
      closeMenu();
      renderFull();
      placeInlinePlayer();
      return;
    }
    if(act==='hideChannel'){
      blockedChannels.add(v.channelId);
      persistBlocks();
      closeMenu();
      renderFull();
      placeInlinePlayer();
      return;
    }

    if(act==='open'){ closeMenu(); window.open(url,'_blank','noopener'); return; }
    if(act==='copyUrl'){ closeMenu(); copyText(url); return; }

    if(act==='related'){
      closeMenu();
      // ì„ íƒí•œ ì˜ìƒ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ë¡œ ì „í™˜
      searchRelatedById(v.id, true);
      return;
    }

    closeMenu();
  }

  // ===== Mini bar click behavior =====
  $('mini').addEventListener('click', (e)=>{
    if(e.target.closest('.mbtn')) return;
    if(e.target.closest('#seek')) return;
    goToPlayback();
  });

  // ===== Keyboard =====
  window.addEventListener('keydown', (e)=>{
    const tag=(e.target && e.target.tagName||'').toLowerCase();
    const typing = tag==='input' || tag==='textarea' || e.target.isContentEditable;
    if(e.key==='Escape'){ closeMenu(); closeQueue(); removeInlinePlayer(true); return; }
    if(typing) return;
    if(e.code==='Space'){ e.preventDefault(); togglePlay(); }
    if(e.key.toLowerCase()==='n') next();
    if(e.key.toLowerCase()==='p') prev();
    if(e.key.toLowerCase()==='q') openQueue();
    if(e.key.toLowerCase()==='g') goToPlayback();
  });

  // ===== Expose =====
  window.saveKey=saveKey;
  window.clearKey=clearKey;
  window.searchVideos=searchVideos;
  window.toggleView=toggleView;

  window.onItemClick=onItemClick;

  window.openQueue=openQueue;
  window.closeQueue=closeQueue;
  window.clearQueue=clearQueue;
  window.queuePlay=queuePlay;
  window.queueDel=queueDel;
  window.queueMove=queueMove;

  window.openNewTab=openNewTab;
  window.closePlayer=closePlayer;

  window.openMenu=openMenu;
  window.closeMenu=closeMenu;
  window.menuAction=menuAction;

  window.refreshRelated=refreshRelated;

  window.togglePlay=togglePlay;
  window.prev=prev;
  window.next=next;
  window.goToPlayback=goToPlayback;
</script>
</body>
</html>
